<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Traductor CSS a Fluid JS</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="description" content="Traductor de CSS a Fluid UI JS">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css" />

    <!-- Fluid UI & Styles -->
    <script src="js/fluid.js"></script>

    <!-- CodeMirror Main Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #root {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: 1rem 2rem;
            background-color: #252526;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h1 {
            margin: 0;
            font-size: 1.2rem;
            color: #00AEEF;
        }

        .container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #333;
            min-width: 0;
            /* Fix flex overflow */
        }

        .pane:last-child {
            border-right: none;
        }

        .pane-header {
            padding: 0.5rem 1rem;
            background-color: #2d2d2d;
            font-size: 0.9rem;
            font-weight: 600;
            color: #ccc;
            border-bottom: 1px solid #333;
        }

        .editor-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .CodeMirror {
            height: 100% !important;
            font-family: 'Fira Code', Consolas, monospace;
            font-size: 14px;
        }

        .error-container {
            background-color: #5a1d1d;
            color: #ffcccc;
            padding: 1rem;
            border-top: 1px solid #ff0000;
            font-family: monospace;
            max-height: 150px;
            overflow-y: auto;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
            const [cssInput, setCssInput] = useState("");
            const [jsOutput, setJsOutput] = useState("");
            const [error, setError] = useState(null);

            const cssEditorRef = useRef(null);
            const jsEditorRef = useRef(null);
            const cssInstance = useRef(null);
            const jsInstance = useRef(null);

            useEffect(() => {
                // Initialize CSS Editor
                if (cssEditorRef.current && !cssInstance.current) {
                    cssInstance.current = CodeMirror(cssEditorRef.current, {
                        mode: "css",
                        theme: "dracula",
                        lineNumbers: true,
                        lineWrapping: true,
                        value: cssInput
                    });

                    cssInstance.current.on("change", (instance, changeObj) => {
                        if (changeObj.origin === "setValue") return;
                        const value = instance.getValue();
                        setCssInput(value);
                        translateToJS(value);
                    });
                }

                // Initialize JS Editor
                if (jsEditorRef.current && !jsInstance.current) {
                    jsInstance.current = CodeMirror(jsEditorRef.current, {
                        mode: "javascript",
                        theme: "dracula",
                        lineNumbers: true,
                        lineWrapping: true,
                        readOnly: false, // Enable editing
                        value: jsOutput
                    });

                    jsInstance.current.on("change", (instance, changeObj) => {
                        if (changeObj.origin === "setValue") return;
                        const value = instance.getValue();
                        setJsOutput(value);
                        translateToCSS(value);
                    });
                }
            }, []);

            useEffect(() => {
                if (cssInstance.current && cssInstance.current.getValue() !== cssInput) {
                    cssInstance.current.setValue(cssInput);
                }
            }, [cssInput]);

            useEffect(() => {
                if (jsInstance.current && jsInstance.current.getValue() !== jsOutput) {
                    jsInstance.current.setValue(jsOutput);
                }
            }, [jsOutput]);

            const translateToJS = (css) => {
                try {
                    setError(null);
                    if (!css.trim()) {
                        setJsOutput("");
                        return;
                    }

                    if (typeof FluidUI === 'undefined' || !FluidUI.traductor) {
                        throw new Error("FluidUI.traductor no está disponible. Asegúrate de que fluid.js se cargó correctamente.");
                    }

                    const result = FluidUI.traductor(css);
                    setJsOutput(result);
                } catch (err) {
                    console.error(err);
                    setError(err.message);
                    // Don't clear output on error to keep previous valid state or allow partial edits
                }
            };

            const translateToCSS = (js) => {
                try {
                    setError(null);
                    if (!js.trim()) {
                        setCssInput("");
                        return;
                    }

                    if (typeof FluidUI === 'undefined' || !FluidUI.toCSS) {
                        throw new Error("FluidUI.toCSS no está disponible.");
                    }

                    // Eval the JS to get the arrow function
                    // We expect the JS to be an arrow function like $ => ({ ... })
                    // We need to be careful with eval.
                    let arrowFn;
                    try {
                        // Check syntax first by wrapping in parens
                        // This prevents executing arbitrary statements if it's just an object literal, 
                        // but here we expect a function.
                        arrowFn = eval(js);
                    } catch (e) {
                        // Syntax error or runtime error during eval
                        // Do not update CSS
                        return;
                    }

                    if (typeof arrowFn !== 'function') {
                        // Not a function, ignore
                        return;
                    }
                    
                    // Try to generate CSS
                    // If toCSS fails (e.g. invalid structure returned by function), catch it
                    console.log(arrowFn);
                    const result = FluidUI.toCSS(arrowFn);
                    setCssInput(result);
                } catch (err) {
                    console.error("Error translating JS to CSS:", err);
                    // Do not update CSS on error
                }
            };

            return (
                <div style={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
                    <div className="header">
                        <h1><i className="fas fa-exchange-alt"></i> Traductor CSS a Fluid JS</h1>
                    </div>
                    <div className="container">
                        <div className="pane">
                            <div className="pane-header">CSS (Entrada)</div>
                            <div className="editor-container" ref={cssEditorRef}></div>
                            {error && (
                                <div className="error-container">
                                    <strong>Error:</strong> {error}
                                </div>
                            )}
                        </div>
                        <div className="pane">
                            <div className="pane-header">Fluid JS (Salida)</div>
                            <div className="editor-container" ref={jsEditorRef}></div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>